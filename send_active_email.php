<?php
require_once("function/db_mysqli.php");
require_once("function/function.php");
$db = new DB();
if(isset($_POST['stunum']))
{
    $user = $db->getRow("select * from user where stunum='".$_POST['stunum']."'");
    $new_card = $db->getRow("select * from new_card where stunum='".$_POST['stunum']."'");
    $subject = "邮件激活-拯救小布的最后一步";
    $token = random(16);
    /*$body = "
        ?????人????????С?????????<br><br>
        ?????????????????????????????????????????????С?????????????????绰???????????<br><br>
        ????????????????????????????????????????????<br><br>
        <a href = 'http://system.lib.whu.edu.cn/game2018/fresh2019/activate.php?token=$token'>???????</a><br><br>
        ?????????????????????????????token?????????????????????????????????
    ";*/
    $body = "123456";
    if(!empty($user) && intval($new_card['new_card_way']) == 0)
    {
        $db->update("user",array(
            "token" => $token,
        ), "stunum = '".$_POST['stunum']."'");
        $to = $user['email'];
        require_once("function/smtp/Send_Mail.php");
        Send_Mail($to, $subject, $body);
        print_r($to);
        print_r($subject);
        print_r($body);
        echo json_encode(array(
            "success" => 1,
            "info" => "邮件已发送"
        ));
    } else if(intval($new_card['new_card_way']) != 0)
        echo json_encode(array(
            "success" => -1,
            "error" => "已经激活过了，因此不再发送邮件"
        ));
    else echo json_encode(array(
        "success" => -2,
        "error" => "用户不存在"
    ));
}
?>